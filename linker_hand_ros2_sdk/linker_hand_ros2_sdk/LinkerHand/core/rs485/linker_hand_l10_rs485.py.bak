#!/usr/bin/env python3
import os, time
from pymodbus.client import ModbusSerialClient
from typing import List
import numpy as np
_INTERVAL = 0.008  # 8 ms

class LinkerHandL10RS485:

    # Fixed order of 10 motors
    KEYS = ["thumb_cmc_pitch", "thumb_cmc_roll", "index_mcp_pitch", "middle_mcp_pitch",
            "ring_mcp_pitch", "pinky_mcp_pitch", "index_mcp_roll", "ring_mcp_roll",
            "pinky_mcp_roll", "thumb_cmc_yaw"]

    def __init__(self, hand_id=0x27, modbus_port="/dev/ttyUSB0", baudrate=115200):
        self.slave = hand_id
        self.cli = ModbusSerialClient(port=modbus_port, baudrate=baudrate,
                                      bytesize=8, parity="N", stopbits=1)
        if not self.cli.connect():
            raise ConnectionError("RS485 connection failed")

    # --------------------------------------------------
    # Batch interfaces
    # --------------------------------------------------
    # ------------------ Reads ------------------
    def read_angles(self) -> List[int]:
        time.sleep(_INTERVAL)
        return self.cli.read_input_registers(0, count=10, device_id=self.slave).registers

    def read_torques(self) -> List[int]:
        time.sleep(_INTERVAL)
        return self.cli.read_input_registers(10, count=10, device_id=self.slave).registers

    # ---------- Speed ----------
    def read_speeds(self) -> List[int]:
        """Read current speeds (input registers 20–29)"""
        time.sleep(_INTERVAL)
        return self.cli.read_input_registers(20, count=10, device_id=self.slave).registers

    # ---------- Temperature ----------
    def read_temperatures(self) -> List[int]:
        """Read current temperatures (input registers 40–49, in °C)"""
        time.sleep(_INTERVAL)
        return self.cli.read_input_registers(40, count=10, device_id=self.slave).registers

    # ---------- Error codes ----------
    def read_error_codes(self) -> List[int]:
        """Read error codes (input registers 50–59, 0 = OK)"""
        time.sleep(_INTERVAL)
        return self.cli.read_input_registers(50, count=10, device_id=self.slave).registers
    
    # ---------- Version info ----------
    def read_versions(self) -> dict:
        """Read all version info at once (158–163)"""
        time.sleep(_INTERVAL)
        regs = self.cli.read_input_registers(158, count=6, device_id=self.slave).registers
        keys = ["hand_freedom", "hand_version", "hand_number",
                "hand_direction", "software_version", "hardware_version"]
        return regs

    # --------------------------------------------------
    # Individual interfaces for 5 pressure sensors
    # --------------------------------------------------
    def read_pressure_thumb(self) -> np.ndarray:
        return np.array(self._pressure(1), dtype=np.uint8)

    def read_pressure_index(self) -> np.ndarray:
        return np.array(self._pressure(2), dtype=np.uint8)

    def read_pressure_middle(self) -> np.ndarray:
        return np.array(self._pressure(3), dtype=np.uint8)

    def read_pressure_ring(self) -> np.ndarray:
        return np.array(self._pressure(4), dtype=np.uint8)

    def read_pressure_pinky(self) -> np.ndarray:
        return np.array(self._pressure(5), dtype=np.uint8)

    def _pressure(self, finger: int) -> List[int]:
        """Internal: select finger → read 62–157 (96 bytes)"""
        time.sleep(_INTERVAL)
        self.cli.write_register(60, finger, device_id=self.slave)
        time.sleep(_INTERVAL)
        return np.array(self.cli.read_input_registers(62, count=96, device_id=self.slave).registers)
    

    # ------------------ Writes ------------------
    def write_angles(self, vals: List[int]):
        """Set 10 motor angles (holding registers 0–9)"""
        vals = [int(x) for x in vals]
        time.sleep(_INTERVAL)
        self.cli.write_registers(0, values=vals, device_id=self.slave)

    
    def write_speeds(self, vals: List[int]) -> None:
        """Set 10 motor speeds (holding registers 20–29)"""
        vals = [int(x) for x in vals]
        assert self.is_valid_10xuint8(vals), "Expected 10 integers in range 0–255"
        time.sleep(_INTERVAL)
        self.cli.write_registers(20, values=vals, device_id=self.slave)

    def write_torques(self, vals: List[int]) -> None:
        """Set 10 motor torques (holding registers 10–19)"""
        vals = [int(x) for x in vals]
        assert self.is_valid_10xuint8(vals), "Expected 10 integers in range 0–255"
        time.sleep(_INTERVAL)
        self.cli.write_registers(10, values=vals, device_id=self.slave)

    # --------------------------------------------------
    # Context management
    # --------------------------------------------------
    def close(self): self.cli.close()
    def __enter__(self): return self
    def __exit__(self, *_): self.close()

    # --------------------------------------------------
    # Fixed API functions
    # --------------------------------------------------
    def is_valid_10xuint8(self, lst) -> bool:
        if len(lst) < 10:
            lst = [lst[0]] * 10
        lst = [int(x) for x in lst]
        return (
            isinstance(lst, list) and
            len(lst) == 10 and
            all(type(x) is int and 0 <= x <= 255 for x in lst)
        )
    
    def set_joint_positions(self, joint_angles=[0] * 10):
        if self.is_valid_10xuint8(joint_angles):
            self.write_angles(joint_angles)
        else:
            raise ValueError("invalid angles")

    def set_speed(self, speed=[200] * 10):
        """Set speeds — params: list of length 10"""
        self.write_speeds(speed)
            
    
    def set_torque(self, torque=[200] * 10):
        """Set torques — params: list of length 10"""
        self.write_torques(torque)

    def set_current(self, current=[200] * 10):
        """Set current — params: list of length 10"""
        print("Setting current is not supported on L10", flush=True)
        pass

    def get_version(self) -> list:
        """Get current firmware version"""
        return self.read_versions()

    def get_current(self):
        """Get current"""
        print("Getting current is not supported on L10", flush=True)
        pass

    def get_state(self) -> list:
        """Get finger motor states"""
        return self.read_angles()
    
    def get_state_for_pub(self) -> list:
        return self.get_state()

    def get_current_status(self) -> list:
        return self.get_state()
    
    def get_speed(self) -> list:
        """Get current speeds"""
        return self.read_speeds()
    
    def get_joint_speed(self) -> list:
        return self.get_speed()
    
    def get_touch_type(self) -> list:
        """Get pressure-sensing type"""
        return 2
    
    def get_normal_force(self) -> list:
        """Get pressure data: point type"""
        return [-1] * 5
    
    def get_tangential_force(self) -> list:
        """Get pressure data: point type"""
        return [-1] * 5
    
    def get_approach_inc(self) -> list:
        """Get pressure data: point type"""
        return [-1] * 5
    
    def get_touch(self) -> list:
        return [-1] * 5
        
    def get_thumb_matrix_touch(self):
        return self._pressure(finger=1)

    def get_index_matrix_touch(self):
        return self._pressure(finger=2)

    def get_middle_matrix_touch(self):
        return self._pressure(finger=3)

    def get_ring_matrix_touch(self):
        return self._pressure(finger=4)

    def get_little_matrix_touch(self):
        return self._pressure(finger=5)
        
    def get_matrix_touch(self) -> list:
        """Get pressure data: matrix type"""
        return [self._pressure(finger=1), self._pressure(finger=2), self._pressure(finger=3), self._pressure(finger=4), self._pressure(finger=5)]
    
    def get_matrix_touch_v2(self) -> list:
        """Get pressure data: matrix type"""
        return self.get_matrix_touch()
    
    def get_torque(self) -> list:
        """Get current torques"""
        return self.read_torques()
    
    def get_temperature(self) -> list:
        """Get current motor temperatures"""
        return self.read_temperatures()
    
    def get_fault(self) -> list:
        """Get current motor error codes"""
        return self.read_error_codes()


# ------------------- demo -------------------
if __name__ == "__main__":
    with LinkerHandL10RS485(hand_id=0x27, modbus_port="/dev/ttyUSB0", baudrate=115200) as hand:
        angles = hand.read_angles()
        print(dict(zip(LinkerHandL10RS485.KEYS, angles)))

        # Batch set angles
        hand.write_angles([250]*10)

        # Read thumb pressure
        print("thumb pressure:", hand.read_pressure_thumb())
        print("Angles :", dict(zip(LinkerHandL10RS485.KEYS, hand.read_angles())))
        print("Current :", dict(zip(LinkerHandL10RS485.KEYS, hand.read_torques())))
        print("Speed :", dict(zip(LinkerHandL10RS485.KEYS, hand.read_speeds())))
        print("Temperature :", dict(zip(LinkerHandL10RS485.KEYS, hand.read_temperatures())))
        print("Error codes:", dict(zip(LinkerHandL10RS485.KEYS, hand.read_error_codes())))
        print("+=" * 30)
        ver = hand.get_version()
        print(list(ver))
